<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CQ</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">

<link rel="stylesheet" type="text/css" href="/css/navBar.css">
<link rel="stylesheet" type="text/css" href="/css/sidebar.css">
<link rel="stylesheet" type="text/css" href="/css/communitystyle.css">
<link rel="stylesheet" type="text/css" href="/css/sirstyle.css">
<link rel="stylesheet" type="text/css" href="/css/discussion.css">
<link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">

<script src="http://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

<script src="/script/trumbowyg.min.js"></script>

<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
</head>
<body>
<% include paritials/topbar.ejs %>
<% if(data.isActive == "true"){ %>
  <% include paritials/sidebar.ejs %>
<% } %>
<div id="page-content-wrapper" style="position: relative;top: 70px;"> <!--Margin Top is new-->
  <div class="container-fluid page-content-div" style="padding:0">
    <div class="row">
      <div class="col-lg-12 scoll-possible" style="padding:0">
        <div class="community-header-top communityheader-profile-mobile" style="padding-top:6px;position:relative;">
          <center>
          <div class="communityprofile-name-mobile" style="max-height:40px;overflow:scroll">
            <a href="" style="color:white"></a>
          </div>
          </center>
        </div>
        <div class="container community-profile-conatiner">
        <div class="col-sm-2 col-xs-12 center-mobile pc">
          <a href="">
          <img src="<%=data2.photoloc%>" class="img-communityprofile-pic allSides" style="background:#fff">
          </a>
        </div>
        <div class="col-sm-8 communityprofile-name-pc communityprofile-system">
          <a href="" class="communityprofile-name-pc">
          <p><%=data2.name%></p>
          </a>
        </div>
        <div class="col-sm-2 col-xs-12 center-mobile" style="padding-top:10px;float:right">
          <div class="dropdown">
            <button class="btn btn-default dropdown-toggle commuity-profile-menu-btn" type="button" data-toggle="dropdown">
            <i class="fa fa-bars"></i>
            </button>
            <ul class="dropdown-menu custom-commuity-dropdown dropdown-menu-right" style="margin-top:40px">
            <li>
            <a href="" class="community-profile-option-btn">
            Discussions
            </a>
            </li>
            <li id="hideManage">
            <a href="/community/setting/<%=data2._id%>" class="community-profile-option-btn">
            Manage Community
            </a>
            </li>
            <li>
            <a href="/community/info/<%=data2._id%>" class="community-profile-option-btn">
            Community Profile
            </a>
            </li>
            <li>
            <a href="/community/showCommunityMembers/<%=data2._id%>" class="community-profile-option-btn">
            Community Members
            </a>
            </li>
          </ul>
          </div>
        </div>
      </div>

      <center>
      <hr style="border-top:2px solid #E6E6E6;width:85%;margin-top:0">
      </center>
      <div class="container" style="width:90% !important">
      </div>
      <div class="container discussion-input discussion-container">
        <div class="panel panel-default allSidesSoft" style="border-radius:0;border:1px solid rgb(182, 182, 182) !important;">
          <div class="panel-body" style="padding:5px;background:#f9f9f9;">
            <div class="col-sm-1 col-xs-3">
              <a href="">
              <img src="<%=data2.photoloc%>" class="discussion-com-profile-pic allSidesSoft" id="dpimage" style="border:2px solid #fff;width: 50px;height: 50px;">
              </a>
            </div>
            <p class="col-sm-11 col-xs-9 discussion-heading" style="margin-top: 20px;font-size: 20px;">
            Start a discussion
            </p>
          </div>
          <div class="panel-body discussion-panel-body">
            <div class="col-sm-12 col-xs-12" style="padding:0;border-top: 1px solid white;">
              <input type="text" style="width:100%" class="discussion-input-title" name="title" placeholder="Enter a discussion title....." id="discussion_title" autocomplete="off" required="">
            </div>
          </div>
          <div class="panel-body discussion-body" style="display: block;width: 100%;">
            <div class="col-sm-12 col-xs-12" style="padding:0;border-top: 1px solid white;">
              <textarea class="discussion-body-textarea" name="details" placeholder="Enter discussion details" id="discussion_details" autocomplete="off" required=""></textarea>
            </div>

            <div class="link-preview-main col-sm-12 col-xs-12">
            </div>
          <div class="tag-conatiner-custom-div">
          <select id="tagEditor" name="tags" class="form-control input-sm select2-multiple select2-hidden-accessible" style="width:100%"  >
          <!--Tags option appended here-->
          <option class="tagSuggestInput">Hello</option>
          <option class="tagSuggestInput">Hey</option>
          <option class="tagSuggestInput">Rid</option>
          <option class="tagSuggestInput">Ram</option>
          <option class="tagSuggestInput">Ji</option>
          <option class="tagSuggestInput">QWE</option>
          <option class="tagSuggestInput">Looo</option>
          <option class="tagSuggestInput">Bye</option>
          <option class="tagSuggestInput">Bro</option>
          <option class="tagSuggestInput">Li</option>
          </select>
          </div>
<div class="image-preview-main col-sm-12 col-xs-12" >
<center>
<img src="" class="allSides preview-image" id="previewImage">
</center>
</div>
<input type="file" multiple="" class="discussion-file-btn" name="discussionImageFile" id="discussionImageFile" accept="image/x-png,image/gif,image/jpeg">
<div class="col-sm-12 col-xs-12" style="padding:0; ">
<a class="discussion-image-btn" id="discussionImageClickBtn" style="width:40px;height: 40px;"><i class="fa fa-image" ></i></a>
<button class="btn btn-primary" type="submit" style="float:right" id="discussion_post">
<p class="discussion-post-btn-txt">Post</p>
</button>
</div>
</div>
<div class="panel-footer"></div>
</div>
</div>
<div id="discussionsList"></div>
</div>
</div>
</div>
<div>  
</div>
</div>
</div>
</div>
</div>
<script type="text/javascript">
  var hideManage = document.getElementById('hideManage');
  var commid ="<%= data2._id %>";
  var email_id ="<%= data.email %>";
$(document).ready(function() {
    initaliseusers();   
    initaliseDiscussions();
})
function initaliseusers()
{
  var xml=new XMLHttpRequest();
  xml.open("POST","/communityTable/getUsers");
  xml.setRequestHeader("Content-Type","application/json");
  xml.addEventListener("load",function()
  {
      var data=JSON.parse(xml.responseText);
     
      for(i in data)
      {
        addtoUserDOM(data[i])
      }
  })
  xml.send(JSON.stringify({"_id":commid}));
}
function initaliseDiscussions()
{
  //   var n = "<%=data.name%>";
  //   var ob = new Object();
  //   ob.communityName = "<%=data2.name%>";
  //    var xml=new XMLHttpRequest();
  // xml.open("POST","/discussion/getDiscussion");
  // xml.setRequestHeader("Content-Type","application/json");
  // xml.addEventListener("load",function()
  // {
  //     var data=JSON.parse(xml.responseText);
  //    //console.log(data)
  //     for(j in data)
  //     {
  //       if(data[j].createdBy == n)
  //       {
  //         addtoDiscussionDOM(data[j])
  //       }
  //       else
  //       {
  //         addtoDiscussionDOMwithOutOptions(data[j])
  //       }
  //     }
  // })
  // xml.send(JSON.stringify(ob));
}
function addtoUserDOM(obj)
{
  if(obj.email == email_id)
  {
     hideManage.setAttribute("style", "display:none");
  }
}
var discussion_title = document.getElementById('discussion_title');
var discussion_details = document.getElementById('discussion_details');
var tagEditor = document.getElementById('tagEditor');
var discussion_post = document.getElementById('discussion_post');
discussion_post.addEventListener("click",function() {
  if(discussion_title.value == '' || discussion_details.value  == '')
  {
    alert("Field can't be Empty");
  }
    var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1;
    var yyyy = today.getFullYear();
    var hrs = today.getHours();
    var mins = today.getMinutes();
    var format = "AM";
    if(hrs>12)
    {
        hrs=hrs-12;
        format="PM";
    }
    today = + dd + '-' + getMonths(mm) + '-' + yyyy;
    today = today + " ";
    today = today + "(" + hrs + ':' + mins + '' + format + ")";
  var obj = new Object();
  obj.title = discussion_title.value;
  obj.details = discussion_details.value;
  obj.tag = tagEditor.value;
  obj.communityName = "<%=data2.name%>";
  obj.createdBy = "<%= data.name %>";
  obj.createdDate = today;
  obj.ownerId = "<%= data.ides %>";
  console.log(obj);
  var request = new XMLHttpRequest();
    request.open('POST',"/discussion/addnewDiscussion");
    request.setRequestHeader("Content-Type","application/json");
    request.send(JSON.stringify(obj))
    request.addEventListener("load",function() {
        console.log("Data Posted Successfully");
        alert("New Discussion Is Registred");
  });  
    location.reload();
})
function addtoDiscussionDOM(obj)
{
  console.log(obj)
     var div = '<div class="container discussion-container">'
                +'<div class="panel panel-default allSidesSoft" style="background:white;">'
                  +'<div class="dropup" style="margin-right: 10px;">'
                    +'<a class="discussion-dropdown-menu" data-toggle="dropdown" style="float:right !important" aria-expanded="false"><i class="fa fa-ellipsis-h"></i></a>'
                    +'<ul class="dropdown-menu dropdown-menu-right dropdown-menu-discussion">'
                      +'<li><a class="request-dropdown-options" onclick=deleteDiscussion("'+obj._id+'")>Delete</a></li>'
                      +'<li id=""><a class="request-dropdown-options" onclick="" id="">Feature</a></li>'
                      +'<li id=""><a class="request-dropdown-options" onclick="" id="">Publish to CQ</a></li>'
                    +'</ul>'
                  +'</div>'
                  +'<div class="panel-body" style="padding:0; padding-top:10px;">'
                    +'<div class="col-sm-12 col-xs-12 col-lg-12 col-md-12 discussion-title">'
                      +'<a class="discussion-title" href="#" target="">'+obj.title+'</a>'
                    +'</div>'
                    +'<div class="col-sm-12 col-xs-12 col-lg-12 col-md-12 discussion-head"> posted by <a href="/discussion/discussionOwner/'+obj.ownerId+'">'+obj.createdBy +'</a> at '+obj.createdDate +'</div>'
                  +'</div>'
                  +'<div class="panel-body" style="padding:0;padding-top:10px;">'
                    +'<div class="col-sm-12 col-xs-12 col-lg-12 col-md-12 discussion-content" style="font-size:16px">'+obj.details +'</div>'
                  +'</div>'
                +'</div>'
              +'</div>';
      $('#discussionsList').append(div);
  }
  function addtoDiscussionDOMwithOutOptions(obj)
  {
    var div = '<div class="container discussion-container">'
                +'<div class="panel panel-default allSidesSoft" style="background:white;">'
                  +'<div class="panel-body" style="padding:0; padding-top:10px;">'
                    +'<div class="col-sm-12 col-xs-12 col-lg-12 col-md-12 discussion-title">'
                      +'<a class="discussion-title" href="#" target="">'+obj.title+'</a>'
                    +'</div>'
                    +'<div class="col-sm-12 col-xs-12 col-lg-12 col-md-12 discussion-head"> posted by <a href="/discussion/discussionOwner/'+obj.ownerId+'">'+obj.createdBy +'</a> at '+obj.createdDate +'</div>'
                  +'</div>'
                  +'<div class="panel-body" style="padding:0;padding-top:10px;">'
                    +'<div class="col-sm-12 col-xs-12 col-lg-12 col-md-12 discussion-content" style="font-size:16px">'+obj.details +'</div>'
                  +'</div>'
                +'</div>'
              +'</div>';
    $('#discussionsList').append(div); 
  }
  function deleteDiscussion(ides)
  {
    var filename = ides;
    console.log(filename);
    var request = new XMLHttpRequest();
    request.open('DELETE',"/discussion/deleteDiscussion/" + filename);
    request.send()
    request.addEventListener("load",function(event)
    {
      location.reload();        
       console.log(request.responseText);
    }); 
  }
function getMonths(mno) {
    var month = ["Jan","Feb","March","April","May","June","July","Aug","Sep","Oct","Nov","Dec"];
    return month[mno-1];
}
</script>
</body>
</html>

